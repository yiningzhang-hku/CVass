# CVassit 重构说明 - 后端服务 + Free/Pro 模式

## 概述

本次重构将 LLM 调用从前端移到后端，并实现了 Free/Pro 模式。

## 后端服务

### 安装和运行

1. 进入后端目录：
```bash
cd backend
```

2. 安装依赖：
```bash
npm install
```

3. 配置环境变量：
```bash
cp .env.example .env
```

编辑 `.env` 文件，设置 Pro 模式的 Qwen API Key：
```
PRO_QWEN_API_KEY=your_qwen_official_api_key_here
PRO_QWEN_MODEL=Qwen/Qwen2.5-32B-Instruct
```

4. 启动服务：
```bash
# 开发模式（自动重启）
npm run dev

# 生产模式
npm start
```

服务默认运行在 `http://localhost:3000`

### API 端点

#### POST /api/parse-resume
解析简历文件，返回结构化 profile。

**Free 模式请求**:
```json
{
  "mode": "free",
  "provider": "siliconflow",
  "apiKey": "用户API Key",
  "model": "Qwen/Qwen2.5-32B-Instruct",
  "fileName": "resume.pdf",
  "fileContentBase64": "..."
}
```

**Pro 模式请求**:
```json
{
  "mode": "pro",
  "fileName": "resume.pdf",
  "fileContentBase64": "..."
}
```

#### POST /api/fill-mapping
根据 profile 和字段列表生成填充映射。

**Free 模式请求**:
```json
{
  "mode": "free",
  "provider": "siliconflow",
  "apiKey": "用户API Key",
  "model": "Qwen/Qwen2.5-32B-Instruct",
  "profile": { ... },
  "fields": [ ... ]
}
```

**Pro 模式请求**:
```json
{
  "mode": "pro",
  "profile": { ... },
  "fields": [ ... ]
}
```

## 前端配置

### 模式选择

在扩展的「⚙️ 设置」页面：

1. **免费模式 (Free)**：
   - 选择"免费模式"
   - 配置 Provider（SiliconFlow/DeepSeek/Qwen/Kimi）
   - 输入 API Key
   - 选择模型

2. **Pro 模式**：
   - 选择"Pro 模式"
   - 无需配置 API Key（使用后端内置的 Qwen Key）
   - 当前版本无付费限制

3. **后端地址**：
   - 默认：`http://localhost:3000`
   - 可根据实际情况修改

### 使用流程

1. **上传并解析简历**：
   - 在「📝 简历」页面上传 PDF/Word 文件
   - 点击"上传并解析简历"
   - 系统会调用后端 `/api/parse-resume` 接口
   - 解析结果会自动填入表单

2. **智能填充**：
   - 在目标网页打开扩展
   - 点击"🤖 开始智能填充"
   - 系统会：
     - 先执行基础规则填充（content.js）
     - 然后调用后端 `/api/fill-mapping` 生成映射
     - 最后将映射应用到页面

3. **快速填充**：
   - 上传简历文件后，点击"⚡ 快速填充"
   - 系统会快速解析并填充（目标10秒内）

## 支持的 Provider

- `siliconflow`: SiliconFlow（通过 SiliconFlow API）
- `deepseek_official`: DeepSeek 官方 API
- `qwen_official`: 通义千问官方 API
- `kimi_official`: Kimi 官方 API
- `internal_qwen`: 内部 Qwen（Pro 模式使用）

## 注意事项

1. **后端服务必须运行**：前端所有 LLM 调用都改为访问后端，确保后端服务正常运行。

2. **网络连接**：确保前端可以访问后端地址（默认 localhost:3000）。

3. **Pro 模式配置**：需要在后端 `.env` 文件中配置 `PRO_QWEN_API_KEY`。

4. **向后兼容**：`content_script.js` 和 `content.js` 的接口保持不变，确保现有功能正常。

## 文件变更

### 新增文件
- `backend/` - 后端服务目录
  - `server.js` - Express 服务器
  - `services/resumeParser.js` - 简历解析服务
  - `services/mappingGenerator.js` - 映射生成服务
  - `services/llmProvider.js` - LLM Provider 适配层
  - `package.json` - 后端依赖
  - `.env.example` - 环境变量示例

### 修改文件
- `popup.html` - 增加模式选择 UI
- `popup.js` - 改为调用后端 API
- `manifest.json` - 增加后端地址权限

### 保持不变
- `content_script.js` - 表单扫描和填充逻辑
- `content.js` - 基础规则填充
- `profile.js` - 保留工具函数（可选）

## 后续扩展

1. **授权系统**：可以在后端增加 `/api/license/status` 接口，实现真正的 Pro 模式授权检查。

2. **多后端支持**：可以配置多个后端地址，实现负载均衡。

3. **缓存机制**：可以在后端增加缓存，提高重复请求的响应速度。
